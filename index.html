<!doctype html>
<html lang="en">
<head>
    <meta charset="UTF-8"/>
    <link rel="icon" type="image/png" href="Northsky-IconCentered-Color.png"/>
    <meta property="og:description" content="Northsky Migration Tool - Migrate your ATProto account"/>
    <meta property="og:image" content="Northsky-IconCentered-Color.png">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"/>
    <title>Northsky Migration Tool</title>
    <link rel="stylesheet" href="style.css">
    <script src="https://unpkg.com/alpinejs" defer></script>

    <script type="module">
        import {Migrator, PlcOps} from './src/main.js';

        window.Migrator = new Migrator();
        window.plcOps = new PlcOps();
    </script>

    <script>

        document.addEventListener('alpine:init', () => {
            Alpine.data('migrator', () => ({
                handle: '',
                password: '',
                newPds: 'https://northsky.social',
                newEmail: '',
                newHandle: '',
                inviteCode: null,
                twoFactorCode: null,
                confirmation: false,
                showTwoFactorCodeInput: false,
                error: null,
                showStatusMessage: false,
                askForPlcToken: false,
                plcToken: null,
                plcStatus: null,
                done: false,
                //advance
                showAdvance: false,
                createNewAccount: true,
                migrateRepo: true,
                migrateBlobs: true,
                migrateMissingBlobs: true,
                migratePrefs: true,
                migratePlcRecord: true,
                generateRotationKey: true,
                rotationKeysToAdd: [],
                toggleAdvanceMenu() {
                    this.showAdvance = !this.showAdvance;
                },
                updateStatusHandler(status) {
                    console.log("Status update:", status);
                    document.getElementById("status-message").innerText = status;

                },
                async handleSubmit() {
                    this.error = null;
                    this.showStatusMessage = false;
                    console.log("Form data:", {
                        handle: this.handle,
                        password: this.password,
                        newPds: this.newPds,
                        newEmail: this.newEmail,
                        newHandle: this.newHandle,
                        inviteCode: this.inviteCode,
                        generateRotationKey: this.generateRotationKey,
                    })
                    try {

                        if (this.showTwoFactorCodeInput) {
                            if (this.twoFactorCode === null) {
                                this.error = 'Please enter the 2FA that was sent to your email.'
                            }
                        }
                        if (!this.confirmation) {
                            this.error = 'Please confirm that you understand the risks.'
                        }

                        window.Migrator.createNewAccount = this.createNewAccount;
                        window.Migrator.migrateRepo = this.migrateRepo;
                        window.Migrator.migrateBlobs = this.migrateBlobs;
                        window.Migrator.migrateMissingBlobs = this.migrateMissingBlobs;
                        window.Migrator.migratePrefs = this.migratePrefs;
                        window.Migrator.migratePlcRecord = this.migratePlcRecord;
                        window.Migrator.generateRotationKey = this.generateRotationKey;
                        this.updateStatusHandler('Starting migration...');
                        this.showStatusMessage = true;

                        if (this.generateRotationKey) {
                            createdRotationKeys = await plcOps.createANewSecp256k1();
                            console.log("Created rotation keys");
                            this.rotationKeysToAdd.push(createdRotationKeys);
                        }
                        
                        await window.Migrator.migrate(
                            this.handle,
                            this.password,
                            this.newPds,
                            this.newEmail,
                            this.newHandle,
                            this.inviteCode,
                            this.updateStatusHandler,
                            this.twoFactorCode
                        );
                        if (this.migratePlcRecord) {
                            this.askForPlcToken = true;
                        } else {
                            this.updateStatusHandler('Migration of your repo is complete! But the PLC operation was not done so your old account is still the valid one.');
                        }
                    } catch (error) {
                        console.error(error.error, error.message);
                        if (error.error === 'AuthFactorTokenRequired') {
                            this.showTwoFactorCodeInput = true;
                        }
                        this.error = error.message;
                    }
                },
                async signPlcOperation() {
                    try {
                        this.plcStatus = 'Signing PLC operation...';
                        this.publicRotationKeys = this.rotationKeysToAdd.map(keyPair => keyPair.publicKey);
                        await window.Migrator.signPlcOperation(this.plcToken, this.publicRotationKeys);
                        this.plcStatus = 'PLC operation signed successfully! Your account has been migrated to the new PDS.';
                        this.done = true;
                        // this.askForPlcToken = false;
                    } catch (error) {
                        this.error = error.message;
                        console.error(error);
                    }
                }
            }))
        })
    </script>
</head>
<body>
<div class="container" x-data="migrator">
    <div class="logo-image">
        <img src="Northsky-IconCentered-Color.png" alt="Northsky" style="max-width: 100%; max-height: 100%; object-fit: contain;">
    </div>
    
    <h1 id="heading">Sign Up to Northsky</h1>
    <section>
        <iframe width="560" height="315" src="https://www.youtube.com/embed/wKPBH8j5HDM?si=MfCcTJKBQMQxu38l" title="YouTube video player" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share" referrerpolicy="strict-origin-when-cross-origin" allowfullscreen></iframe>
    </section>
    
    <h2>The Northsky Social team welcomes you to join us in safer skies.</h2>
    
    <a href="/info.html">Learn more about account migrations</a>
    <form x-show="!askForPlcToken && !done" id="moover-form" @submit.prevent="await handleSubmit()">
        <!-- First section: Login credentials -->
        <div class="section">
            <h2>Login for your current PDS</h2>
            <div class="form-group">
                <label for="handle">Old Handle:</label>
                <input type="text" id="handle" name="handle" placeholder="alice.bsky.social" x-model="handle" required>
            </div>

            <div class="form-group">
                <label for="password">Old Password (Will also be your new password):</label>
                <input type="password" id="password" name="password" x-model="password" required>
            </div>

            <div x-show="showTwoFactorCodeInput" class="form-group">
                <label for="two-factor-code">2FA from the email sent</label>
                <input type="text" id="two-factor-code" name="two-factor-code" x-model="twoFactorCode">
                <div class="error-message">Enter your 2fa code here</div>

            </div>
        </div>

        <!-- Second section: New account details -->
        <div class="section">
            <h2>Setup for Northsky</h2>

            <div class="form-group">
                <label for="new-email">New Email:</label>
                <input type="email" id="new-email" name="new-email" placeholder="CanBeSameEmailAsTheOldPds@email.com"
                       x-model="newEmail" required>
            </div>

            <div class="form-group">
                <label for="new-handle">New Handle:</label>
                <input type="text" id="new-handle" name="new-handle"
                       placeholder="username.northsky.social or my.customdomain.com" x-model="newHandle" required>
            </div>

            <div class="form-group">
                <label for="invite-code">Invite Code:</label>
                <input type="text" id="invite-code" name="invite-code" placeholder="Enter your invite code"
                       x-model="inviteCode" required>
            </div>
            <div class="form-control">
                <label>
                    <input type="checkbox" id="generateRotationKey" name="generateRotationKey" x-model="generateRotationKey">
                    Generate PLC rotation key (recovery key)
                </label>
            </div>
        </div>
        <div class="form-group">
            <button type="button" @click="toggleAdvanceMenu()" id="advance" name="advance">Advanced Options
            </button>
        </div>
        <div x-show="showAdvance" class="section" style="padding-bottom: 10px;">
            <h3>Pick and choose which actions to run</h3>
            <p>Useful if a migration failed and you want to have a bit more manual control</p>
            <div class="form-control">
                <label>
                    <input type="checkbox" id="createNewAccount" name="createNewAccount" x-model="createNewAccount">
                    Create a New Account on the New PDS
                </label>
            </div>
            <div class="form-control">
                <label>
                    <input type="checkbox" id="migrateRepo" name="migrateRepo" x-model="migrateRepo">
                    Migrate Repo
                </label>
            </div>
            <div class="form-control">
                <label>
                    <input type="checkbox" id="migrateBlobs" name="migrateBlobs" x-model="migrateBlobs">
                    Migrate Blobs
                </label>
            </div>
            <div class="form-control">
                <label>
                    <input type="checkbox" id="migrateMissingBlobs" name="migrateMissingBlobs"
                           x-model="migrateMissingBlobs">
                    Migrate Missing Blobs
                </label>
            </div>
            <div class="form-control">
                <label>
                    <input type="checkbox" id="migratePrefs" name="migratePrefs" x-model="migratePrefs">
                    Migrate Prefs
                </label>
            </div>
            <div class="form-control">
                <label>
                    <input type="checkbox" id="migratePlcRecord" name="migratePlcRecord" x-model="migratePlcRecord">
                    Migrate PLC Record
                </label>
            </div>

        </div>

        <div class="form-control">
            <label>
                <input type="checkbox" id="agree-to-tos" name="agree-to-tos" required>
                I agree to the <a href="https://northskysocial.com/posts/terms-of-service" target="_blank">Northsky Terms of Service</a>
            </label>
        </div>

        <div class="form-control">
            <label>
                <input type="checkbox" id="agree-to-privacy" name="agree-to-privacy" required>
                I agree to the <a href="https://northskysocial.com/posts/privacy-policy" target="_blank">Northsky Privacy Policy</a>
            </label>
        </div>

        <div class="form-control">
            <label>
                <input x-model="confirmation" type="checkbox" id="confirmation" name="confirmation" required>
                I understand the risks that come with doing an account migration.
            </label>
        </div>
        <div x-show="error" x-text="error" class="error-message"></div>
        <div x-show="showStatusMessage" id="warning">*Please make sure to stay on this page during the migration for the
            best result
        </div>
        <div x-show="showStatusMessage" id="status-message" class="status-message"></div>
        <div>
            <button type="submit">Start Migration</button>
        </div>
    </form>
    <div x-show="askForPlcToken && !done" class="section">
        <h2>Please enter the PLC Token you received in an email</h2>
        <form @submit.prevent="await signPlcOperation()">
            <div class="form-group">
                <label for="plc-token">PLC Token:</label>
                <input type="text" id="plc-token" name="plc-token" x-model="plcToken" required>
            </div>
            <div x-show="error" x-text="error" class="error-message"></div>
            <div x-show="plcStatus" x-text="plcStatus" class="status-message"></div>
                <button type="submit">Sign the papers</button>
            </div>
        </form>
    <div x-show="done" class="section">
        <h2>Migration Complete!</h2>
        <div class="status-message">Congratulations! You have successfully migrated to Northsky Social! 
            Remember to use https://northsky.social under "Hosting provider" when logging in on Bluesky. You can find more detailed information
                <a href="/info.html#cant-login">here.</a></div>
        <div x-show="rotationKeysToAdd.length > 0">
            <p>Your rotation keys can be used to restore access to your account in case anything ever happens to Northsky! 
                <strong>You should treat these keys like a password</strong> and store it somewhere safe.</p>
            <p>
                <strong>Public Key:</strong> 
                <code x-text="rotationKeysToAdd[0]?.publicKey"></code>
                <button type="button" @click="navigator.clipboard.writeText(rotationKeysToAdd[0]?.publicKey)" style="margin-left: 8px;">Copy</button>
            </p>
            <p>
                <strong>Private Key:</strong> 
                <code x-text="rotationKeysToAdd[0]?.privateKey"></code>
                <button type="button" @click="navigator.clipboard.writeText(rotationKeysToAdd[0]?.privateKey)" style="margin-left: 8px;">Copy</button>
            </p>
        </div>
    </div>
    <footer>
        <div class="made-by-blur">
            <a href="https://leaflet.pub/2191cd16-e793-4dd8-95ff-c6b02e89bb6a" target="_blank">Northsky Migration FAQ</a> | 
            <a href="mailto:support@northskysocial.com">Contact Support</a>
        </div>
        <div class="made-by-blur">Powered by <a href="https://tangled.org/baileytownsend.dev/pds-moover" target="_blank">pds-moover</a>
        </div>
    </footer>
     
</div>


</body>
</html>

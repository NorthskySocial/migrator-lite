<!doctype html>
<html lang="en">
<head>
    <meta charset="UTF-8"/>
    <link rel="icon" type="image/png" href="/Northsky-IconCentered-Color.png"/>
    <meta property="og:description" content="Northsky Migration Tool - Deactivate Old Account"/>
    <meta property="og:image" content="/Northsky-IconCentered-Color.png">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"/>
    <title>Deactivate Old Account</title>
    <link rel="stylesheet" href="/style.css">
    <script src="https://unpkg.com/alpinejs" defer></script>

    <script type="module">
        import {Migrator} from './src/main.js';

        window.Migrator = new Migrator();
    </script>

    <script>
        document.addEventListener('alpine:init', () => {

            Alpine.data('migrator', () => ({
                oldHandle: '',
                oldPassword: '',
                twoFactorCode: '',
                showTwoFactorCodeInput: false,
                error: null,
                showStatusMessage: false,
                updateStatusHandler(status) {
                    console.log("Status update:", status);
                    document.getElementById("status-message").innerText = status;
                },
                async handleSubmit() {
                    this.error = null;
                    this.showStatusMessage = false;

                    try {

                        if (this.showTwoFactorCodeInput) {
                            if (this.twoFactorCode === null) {
                                this.error = 'Please enter the 2FA that was sent to your email.'
                            }
                        }

                        this.showStatusMessage = true;
                        await window.Migrator.deactivateOldAccount(
                            this.oldHandle,
                            this.oldPassword,
                            this.updateStatusHandler,
                            this.twoFactorCode);
                    } catch (error) {
                        console.error(error.error, error.message);
                        if (error.error === 'AuthFactorTokenRequired') {
                            this.showTwoFactorCodeInput = true;
                        }
                        this.error = error.message;
                    }
                },
            }))
        })
    </script>
</head>
<body>
<div class="container" x-data="migrator">
    <div class="logo-image">
        <img src="/Northsky-IconCentered-Color.png" alt="Northsky" style="max-width: 100%; max-height: 100%; object-fit: contain;">
    </div>
    
    <h1>Deactivate Old Account</h1>
    
    <div class="made-by-blur">Powered by <a href="https://github.com/bluesky-social/pds" target="_blank">pds-moover</a>
    </div>
    <p>Use this page to make sure your old account is deactivated</p>
    <form id="moover-form" @submit.prevent="await handleSubmit()">
        <!-- First section: Login credentials -->
        <div class="section">
            <h2>Login for your old PDS</h2>
            <div class="form-group">
                <label for="handle">Old Handle:</label>
                <input type="text" id="handle" name="handle" placeholder="alice.bsky.social" x-model="oldHandle"
                       required>
            </div>

            <div class="form-group">
                <label for="password">Old Password:</label>
                <input type="password" id="password" name="password" x-model="oldPassword" required>
            </div>

            <div x-show="showTwoFactorCodeInput" class="form-group">
                <label for="two-factor-code">2FA from the email sent</label>
                <input type="text" id="two-factor-code" name="two-factor-code" x-model="twoFactorCode">
                <div class="error-message">Enter your 2fa code here</div>

            </div>
        </div>

        <div x-show="error" x-text="error" class="error-message"></div>
        <div x-show="showStatusMessage" id="status-message" class="status-message"></div>
        <div>
            <button type="submit">Turn it off</button>
        </div>
    </form>
     <footer>
        <div class="made-by-blur"><a href="https://leaflet.pub/2191cd16-e793-4dd8-95ff-c6b02e89bb6a" target="_blank">Northsky Migration FAQ</a></div>
        <div class="made-by-blur"><a href="mailto:support@northskysocial.com">Contact Support</a></div>
        <div class="made-by-blur">Powered by <a href="https://tangled.org/baileytownsend.dev/pds-moover" target="_blank">pds-moover</a>
        </div>
    </footer>
</div>


</body>
</html>
